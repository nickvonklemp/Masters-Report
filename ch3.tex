%****************************************************
%	CHAPTER 3 - Dynamics
%****************************************************
\chapter{Kinematics \& Dynamics}
\label{ch:dynamics}
%====================================================
The body's dynamics are first solved as rigid, with appropriate equations derived for generic 6-DOF motion. There after, non-linear aerodynamic and inertial effects, unique to multi-body relative rotations, are presented and introduced into the plant's model. Finally a consolidated, quaternion based plant model is presented which is used for the later control plant development next in Chapter:\ref{ch:control}.
%====================================================
\section{Rigid Body Dynamics}
\label{sec:dynamics.rigidbody}
%====================================================
\subsection{Lagrange Derivation}
\label{subsec:dynamics.rigidbody.lagrange}
%====================================================
Fundamentally any body, rigid or otherwise, can undergo two kinds of movements, namely rotational and translation motions. Often a Lagrangian\cite{classicaldynamics,rotationrigidbody} approach for combined angular and translational movements is used to derive the differential equations of motion for each degree of freedom. The Lagrangian principle ensures that translational and rotational kinematic energies and potential energy are conserved all throughout the system's trajectory progression. When combined with Euler-Rotational equations, the Euler-Lagrangian\cite{lagrange-formalism} formulation fully defines the aerospace 6-DOF equation set.
\par
Lagrangian formalism is regarded as especially useful in non-cartesian (\emph{spherical etc\ldots}) co-ordinate frames and multi-body systems. With that being said, a cartesian co-ordinate system was already defined in Section:\ref{subsec:proto.conventions.motoraxis}, rigid body dynamics in a cartesian co-ordinate frame do lend themselves to Newtonian mechanics. The Newtonain-Euler or Euler-Lagrange formulations stipulate the same resultant equations. The Lagrangian operator, $\mathcal{L}$, is a term made up of the difference between kinetic and potential energies, $T$ and $U$ respectively. Considering some generalized path co-ordinates $\mathbf{r}(t)$, for both linear $\mathcal{E}$ and angular $\eta$ relative positions;
\begin{equation}\label{eq:generalpath}
\mathbf{r}(t)=\begin{bmatrix}
\mathcal{E} & \eta
\end{bmatrix}^T
\end{equation}
The co-ordinates in Eq:\ref{eq:generalpath} are generalized here, despite being symbols commonly used to represent linear and angular positions. The generalized co-ordinates are later be refined as Cartesian body co-ordinates with respect to the inertial frame. The Lagrangian, by definition, is then:
\begin{subequations}
\begin{equation}\label{eq:lagrangian.a}
\mathcal{L}(\mathbf{r},\dot{\mathbf{r}},t)=T(\mathbf{r},\dot{\mathbf{r}})-U(\mathbf{r},\dot{\mathbf{r}})
\end{equation}
Introducing generic kinetic (angular \& linear) and potential energies, the latter being only gravitational potential energy in this case;
\begin{equation}\label{eq:lagrangian.b}
\mathcal{L}=\frac{1}{2}\dot{\mathcal{E}}^{T}(m)\dot{\mathcal{E}}+\frac{1}{2}\dot{\eta}^T(\mathbb{I})\dot{\eta}-mgz
\end{equation}
\end{subequations}
\newpage
Noting that $\mathbb{I}$ is the inertial tensor aligned w.r.t to whichever generalized coordinates are being used. The Euler-Lagrange formulation equates partial derivatives of the Lagrangian to any generalized forces, $\mathbf{V}$, acting on the system. In this case the generalized forces or a net force, $F~~[N]$, and a net torque, $\tau~~[N.m]$.
\begin{equation}\label{eq:euler-lagrange}
\frac{d}{dt}\bigg(\frac{\delta L}{\delta \dot{\mathbf{r}}}\bigg)-\frac{\delta L}{\delta \mathbf{r}} = \mathbf{V} = \begin{bmatrix}
F\\
\tau
\end{bmatrix}
\end{equation}
Taking the partial derivatives of Eq:\ref{eq:lagrangian.b} with respect to its path co-ordinates $\mathbf{r}$:
\begin{subequations}
\begin{equation}\label{eq:partial.a}
\frac{\delta L}{\delta \mathbf{r}}=\begin{bmatrix}
mG\\
0
\end{bmatrix}
\end{equation}
\vspace{-5pt}
\begin{equation}\label{eq:partial.b}
\frac{d}{dt}\bigg(\frac{\delta L}{\delta \dot{\mathbf{r}}}\bigg)=\bigg[
m\frac{d}{dt}\dot{\mathcal{E}} ~~~ \mathbb{I}\frac{d}{dt}\dot{\eta}\bigg]^T
\end{equation}
\end{subequations}
In any generalized coordinate system a rotating vector's time derivative, according to the Reynolds Transportation Theorem\cite{reynolds,conservationequations}, is given by:
\begin{equation}\label{eq:reynolds}
\frac{d\vec{f}}{dt_a}=\frac{d\vec{f}}{dt_b}+\vec{\omega}_{a/b}\times\vec{f}
\end{equation}
So applying that theorem (Eq:\ref{eq:reynolds}) to the partial derivatives in Eq:\ref{eq:partial.b} and further defining the generalized co-ordinates as cartesian body coordinates with respect to an inertial origin. Noting that in Eq:\ref{eq:partial.b} the place holders used for linear and angular positions are in a common shared frame\footnote{In this case $\eta\not=\phi~\theta~\psi]^T$ seeing that it's defined in a common frame}, and hence $[ \dot{\mathcal{E}}~~\dot{\eta} ]^T\equiv [ \nu ~~ \omega]^T\in \mathcal{F}^b$. It then follows that Lagrangian will change:
\begin{subequations}
\begin{equation}
\mathcal{L}=\frac{1}{2}\nu^{T}(m)\nu+\frac{1}{2}\omega^T(\mathbb{I})\omega -mG_b z
\end{equation}
\vspace{-5pt}
\begin{equation}
\frac{d}{dt}\bigg(\frac{\delta L}{\delta \dot{\mathbf{r}}}\bigg)=\bigg[
m\frac{d}{dt}\nu ~~~ \mathbb{I}\frac{d}{dt}\omega\bigg]^T
\end{equation}
\vspace{-5pt}
\begin{equation}
\rightarrow m\frac{d}{dt}\nu_b=m\dot{\nu}+\vec{\omega}_{I/b}\times\nu
\end{equation}
\vspace{-5pt}
\begin{equation}
\rightarrow \mathbb{I}_b \frac{d}{dt}\omega_b=\mathbb{I}_b\dot{\omega}+\omega_{I/b}\times\mathbb{I}_b\omega
\end{equation}
\end{subequations}
Which, when reintroduced to the Euler-Langrage formulation Eq:\ref{eq:euler-lagrange}, results in the familiar Newton-Euler equations for linear and angular movements, both in the body frame;
\begin{subequations}\label{eq:newton}
\begin{equation}\label{eq:newton.a}
F=m\dot{\nu}+\omega_b\times m \nu - m\mathbb{R}_I^b(-\eta) G
\end{equation}
\vspace{-15pt}
\begin{equation}\label{eq:newton.b}
\tau=\mathbb{I}_b\dot{\omega}_b+\omega_b\times\mathbb{I}_b\omega
\end{equation}
\end{subequations}
It's important to recall that $\omega_b\not= \dot{\eta}$ where $\eta=[\phi~\theta~\psi]^T$, seeing that Euler Angles are defined in sequentially rotated reference frames. So the four differential equations often used to completely describe the entire state derivatives are:
\begin{subequations}\label{eq:states}
\begin{equation}
\dot{\mathcal{E}}=\mathbb{R}_b^I(-\eta)\nu~~~~\in\mathcal{F}^I
\end{equation}
\vspace{-15pt}
\begin{equation}
F=m\dot{\nu}+\omega_b\times m\nu -m \mathbb{R}_I^b(-\eta) G ~~~~\in\mathcal{F}^b
\end{equation}
\vspace{-10pt}
\begin{equation}
\dot{\eta}=\Psi(\eta)\omega_b~~~~\in\mathcal{F}^{v2},\mathcal{F}^{v1},\mathcal{F}^I
\end{equation}
\vspace{-10pt}
\begin{equation}
\tau=\mathbb{I}_b\omega_b+\omega_b\times\mathbb{I}_b\omega~~~~\in\mathcal{F}^b
\end{equation}
\end{subequations}
The set of state differentials in Eq:\ref{eq:states} can be reduced to a set of two equations, defined only in their respective reference frames of the state variables which they describe. The non-linear form of those equations substitutes\footnote{Originally introduced in Eq:\ref{eq:angular-rates.e}} $\dot{\eta}=\Phi(\eta)\omega_b$ in the Lagrangian derivative, Eq:\ref{eq:partial.b}.
\begin{equation}
\frac{d}{dt}\bigg(\frac{\delta L}{\delta \dot{\mathbf{r}}}\bigg)=\bigg[m\frac{d}{dt}\nu~~~\mathbb{I}\frac{d}{dt}\dot{\eta}\bigg]=\bigg[m\frac{d}{dt}\nu~~~\mathbb{I}\frac{d}{dt}\Phi(\eta)\omega_b\bigg]
\end{equation}
This only changes the angular component, and so applying the differential chain rule:
\begin{equation}
\mathbb{I}\frac{d}{dt}\Phi(\eta)\dot{\omega}_b=\mathbb{I}\big(\Phi\dot{(\eta)}\omega_b+\Phi(\eta)\dot{\omega}_b \big)
\end{equation}
Drawing from \cite{autonomousrobotseuler} and recognizing that $\mathbb{I}$ must be transformed to common axes, $\mathbb{J}=\Psi(\eta)^T\mathbb{I}\Psi(\eta)$. The controllable differential equations in Eq:\ref{eq:newton}, then in the inertial frame for force and intermediate Euler frames for each angle becomes\footnote{The relationship $\dot{\Phi}=\Phi\dot{\Psi}\Phi$ was used to simplify Eq:\ref{eq:nonlinear}, the singularity in $\Phi$ still remains\ldots}:
\begin{subequations}\label{eq:nonlinear}
\begin{equation}
M(\eta)\ddot{\eta}+C(\eta,\dot{\eta})\dot{\eta}=\Psi(\eta)\tau
\end{equation}
\vspace{-10pt}
\begin{equation}
M(\eta)=\Psi(\eta)^T\mathbb{I}\Psi(\eta)
\end{equation}
\vspace{-10pt}
\begin{equation}
C(\eta,\dot{\eta})=-\Psi(\eta)\mathbb{I}\Psi\dot{(\eta)}+\Psi(\eta)^T sk(\Psi(\eta)\dot{\eta})\mathbb{I}\Psi(\eta)
\end{equation}
\end{subequations}
Equation \ref{eq:nonlinear} fully describes the state derivative $\ddot{\eta}$ in its own frame(s). The two differential equations which describe the entire bodies motion are:
\begin{subequations}
\begin{equation}
F=m\dot{\mathcal{E}}+\mathbb{R}_b^I(-\eta)\omega_b \times m \dot{\mathcal{E}}-mG~~~~\in\mathcal{F}^I
\end{equation}
\vspace{-10pt}
\begin{equation}
\Psi(\eta)\tau=M(\eta)\ddot{\eta}+C(\eta,\dot{\eta})~~~~\in\mathcal{F}^{v2},\mathcal{F}^{v1},\mathcal{F}^I
\end{equation}
\end{subequations}
\par
The generalized forces effecting the system, $F$ and $\tau$, are the system's controllable inputs and are going to be affected directly the systems actuators and their associated effectiveness function. In the general case, which is expanded upon in Section:\ref{sec:dynamics.aero}, the control inputs are typically as follows:
\begin{subequations}
The net force acting on the system is just the sum of all thrust vectors produced by rotating propellers, $T(\Omega_i)$.
\begin{equation}
\mu F = \sum \vec{T}_i
\end{equation}
Secondly the net torque is the sum of all torque arms produced from those propeller thrust vectors.
\begin{equation}
\mu \tau = \sum \vec{l}_i \times \vec{T}_i
\end{equation}
\end{subequations}
Where $\vec{T}_i$ is the $i^{th}$ motor's thrust vector, not necessarily in 3 dimensions and $\vec{l}_i$ is that motor's torque arm. The above equations are still applicable to any 6 DOF body, although aspects unique to the quadrotor and tilting quadrotor platforms will now be introduced\ldots
%====================================================
\subsection{Rotation Matrix Singularity}\label{subsec:dynamics.rigidbody.singularity}
%====================================================
The Euler Angle singularity is often noted but infrequently proven mathematically, far less common is the demonstration of exactly how that singularity \emph{mathematically} manifests itself. By definition, a singularity occurs when a loss of differentiability is encountered. In the case of an affixed 3-axis gimbal, when the an intermediate axis, for example the rolling angle $\theta$, is at $\pi$ then the remaining two axes become co-linear. That being a pitch $\phi$ or yaw $\psi$ rotations will subsequently have the same effect. Such a situation results in the deterioration of a degree of freedom.
\begin{figure}
\begin{subfigure}{0.5\textwidth}
\centering
\includegraphics[width=\textwidth]{figs/gimbal-lock-a}
\caption{3-Axis gimbal}
\end{subfigure}
\begin{subfigure}{0.5\textwidth}
\centering
\includegraphics[width=\textwidth]{figs/gimbal-lock-b}
\caption{Locked gimbal with loss of DOF}
\end{subfigure}
\end{figure} 
\par
What is obvious in a physical system is not necessarily as clear mathematically. A clear loss of differentiability is manifested in the Euler Matrix $\Psi(\eta)$, Eq:\ref{eq:angular-rates.e} from Section:\ref{subsec:proto.conventions.frames}. The relation between angular velocity, in the inertial frame or inversely in the body frame, and the angular rates of the Euler Angles.
\begin{equation}\label{eq:euler-derivative}
\begin{bmatrix}
\dot{\phi}\\
\dot{\theta}\\
\dot{\psi}
\end{bmatrix}
=\begin{bmatrix}
1 & sin(\phi)tan(\theta) & cos(\phi)tan(\theta)\\
0 & cos(\phi) & -sin(\phi)\\
0 & sin(\phi)sec(\theta) & cos(\phi)sec(\theta)\\
\end{bmatrix}
\begin{bmatrix}
p\\
q\\
r
\end{bmatrix}
=\Phi(\eta)\omega_b
\end{equation}
\begin{equation}
\text{As}~\underset{{\theta \rightarrow \pi /2}}{lim}~sec(\theta)\rightarrow \infty
\end{equation}
Or that $\Phi(\eta)$ is undefined at $\theta=\pi/2$. 
It's clear to see that in Eq:\ref{eq:euler-derivative} there exists an undefined singularity as $\theta\rightarrow\pi/2$. The physical consequence of this is the loss of a degree of freedom. More specifically, if one looks at how the rotation (or transformation) matrices are formulated:
\begin{subequations}
\begin{equation}
\mathbb{R}_I^b = \mathbb{R}_z\mathbb{R}_y\mathbb{R}_x=\begin{bmatrix}
c_\psi & -s_\psi & 0\\
s_\psi & c_\psi & 0\\
0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
c_\theta & 0 & s_\theta\\
0 & 1 & 0\\
-s_\theta & 0 & c_\theta
\end{bmatrix}
\begin{bmatrix}
1 & 0 & 0\\
c_\phi & -s_\phi & 0\\
s_\phi & c_\phi & 0
\end{bmatrix}
\end{equation}
\begin{equation}
\mathbb{R}_I^b=\begin{bmatrix}
c_\psi c_\theta & c_\psi s_\theta s_\phi - s_\psi c_\phi & c_\psi s_\theta c_\phi + s_\psi s_\phi\\
s_\psi c_\theta & s_\psi s_\theta s_\phi + c_\psi c_\phi & s_\psi s_\theta  c_\phi - c_\psi s_\phi\\
-s_\theta & c_\theta s_\phi & c_\phi c_\theta\\
\end{bmatrix}
\end{equation}
In the case where $\theta=\pi/2$;
\begin{equation}
=\begin{bmatrix}
0 & c_\psi s_\phi - s_\psi c_\phi & c_\psi c_\phi + s_\psi s_\phi\\
0 & s_\psi s_\phi + c_\psi c_\phi & s_\psi c_\phi - c_\psi s_\phi\\
-1 & 0 & 0\\
\end{bmatrix}
=
\begin{bmatrix}
0 & s(\phi - \psi) & c(\phi - \psi)\\
0 & c(\phi - \psi) & s(\phi - \psi)\\
-1 & 0 & 0
\end{bmatrix}
\end{equation}
\end{subequations}
Where the second term in Eq: represents an x-axis rotation in a new intermeiate frame 
%====================================================
\subsection{Quaternion Dynamics}
\label{subsec:dynamics.rigidbody.quaternion}
%====================================================
\subsection{The Unwinding Problem}
\label{subsec:dynamics.rigidbody.unwinding}
%====================================================

%****************************************************
\section{Non-linearities}
\label{sec:dynamics.nonlinearities}
%****************************************************
\subsection{Gyroscopic Torques}
\label{subsec:dynamics.nonlinearities.gyrotorques}
%****************************************************
\subsection{Coriolis Acceleration}
\label{subsec:dynamics.nonlinearities.coriolis}
%****************************************************
\subsection{Inertial Matrix}
\label{subsec:dynamics.nonlinearities.inertia}
%****************************************************

%****************************************************
\section{Aerodynamics}
\label{sec:dynamics.aero}
%****************************************************
\subsection{Thrust Forces \& Propeller Torques}
\label{subsec:dynamics.aero.bem}
%****************************************************
\subsection{Drag}
\label{subsec:dynamics.aero.drag}
%****************************************************
\subsection{Conning \& Flapping}
\label{subsec:dynamics.aero.flap}
%****************************************************
\subsection{Vortex Ring State}
\label{subsec:dynamics.aero.vrs}
%****************************************************

%****************************************************
\section{Consolidated Model}
\label{sec:dynamics.model}